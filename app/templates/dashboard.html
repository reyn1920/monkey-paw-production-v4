<!doctype html><html><head><meta charset="utf-8"/><title>Monkey Paw — V4</title>
<link rel="stylesheet" href="/static/css/style.css"/></head><body>
<header><h1>Monkey Paw — V4 Dashboard</h1><div class="grid">
<div class="card"><h3>Status</h3><pre id="health">loading…</pre></div>
<div class="card"><h3>Revenue (<span id="revTitleDays">30</span> days)</h3>
<div style="display:flex;align-items:center;gap:8px;margin:6px 0 10px 0">
  <label for="revDays">Timeframe:</label>
  <select id="revDays">
    <option value="7">7</option>
    <option value="30" selected>30</option>
    <option value="60">60</option>
  </select>
  <button id="revReload">Reload</button>
  <small id="revHint" style="opacity:.7">Uses your computer's current date</small>
  </div>
<canvas id="revChart" width="720" height="260"></canvas></div>
<div class="card"><h3>Content KPIs</h3><ul id="kpis"></ul></div>
<div class="card"><h3>$5k Plan</h3><button id="viewPlan">Open</button>
<a href="/static/FIRST_MONTH_5K_PLAN.pdf" target="_blank">Download PDF</a></div></div></header>
<section class="grid"><div class="card"><h3>Pipeline</h3>
<button id="doResearch">research</button><button id="doDraft">draft</button><button id="doRepurpose">repurpose</button>
<button id="approve">approve</button><button id="publish">publish</button></div>
<div class="card">
  <h3>Quick Actions</h3>
  <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px">
    <label for="qaChannel">Channel:</label>
    <select id="qaChannel">
      <option value="right_perspective">right_perspective</option>
      <option value="futuretech_chronicles">futuretech_chronicles</option>
      <option value="next_gen_tech_today">next_gen_tech_today</option>
      <option value="eco_health_living">eco_health_living</option>
    </select>
    <input id="qaTopic" placeholder="topic (optional)" style="flex:1;min-width:200px"/>
    <button id="btnFullVideo">Full Video</button>
    <button id="btnBreaking">Breaking News Now</button>
  </div>
  <small>Uses <code>/api/actions/full_video</code> and <code>/api/actions/breaking_news</code>. See status below in Jobs.</small>
  </div>
  <div class="card">
    <h3>Jobs</h3>
    <div style="display:flex;gap:8px;margin-bottom:8px">
      <button id="jobsRefresh">Refresh</button>
    </div>
    <pre id="jobsOut" style="max-height:240px;overflow:auto"></pre>
  </div>
  <div class="card">
  <h3>Live Data</h3>
  <div style="display:flex;gap:8px;flex-wrap:wrap">
    <button id="refreshData">Refresh Data</button>
    <button id="setSheets">Set Sheets URLs</button>
    <button id="setSheetFromUrl">Set From Sheet URL</button>
  </div>
  <small>Uses public Google Sheets CSV URLs configured in <code>config/sheets.yaml</code>.</small>
  <pre id="refreshResult" style="max-height:160px;overflow:auto"></pre>
  </div>
  <div class="card">
    <h3>Channels Explorer</h3>
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px">
      <label for="srcSel">Source:</label>
      <select id="srcSel"></select>
      <label for="keySel">Tab Key:</label>
      <select id="keySel"></select>
      <button id="fetchSheet">Fetch</button>
    </div>
    <small>Sources and keys come from <code>config/sheets_multi.json</code>. Use /api/sheets/{source}/{key}.</small>
    <pre id="sheetOut" style="max-height:220px;overflow:auto"></pre>
  </div>
  <div class="card">
    <h3>Admin</h3>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px">
      <button id="panicOn">Panic ON</button>
      <button id="panicOff">Panic OFF</button>
      <button id="checkPanic">Check Panic</button>
      <button id="checkLastRefresh">Last Refresh</button>
    </div>
    <div><small>Panic prevents publishing; toggles a file at <code>reports/PANIC_SWITCH.true</code>.</small></div>
    <pre id="adminOut" style="max-height:160px;overflow:auto"></pre>
  </div>
</section>
<script src="/static/js/tinychart.js"></script>
<script>
async function g(u){return (await fetch(u)).json()}
async function p(u,b){return (await fetch(u,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(b||{})})).json()}
(async()=>{
document.getElementById('health').textContent=JSON.stringify(await g('/api/health'),null,2);
const k=await g('/api/metrics/content');
const ul=document.getElementById('kpis'); Object.entries(k).forEach(([a,b])=>{const li=document.createElement('li'); li.textContent=a+': '+b; ul.appendChild(li)});
const ctx=document.getElementById('revChart').getContext('2d');
const revDaysSel=document.getElementById('revDays');
const revTitleDays=document.getElementById('revTitleDays');
const revReload=document.getElementById('revReload');
async function loadRevenue(){
  const days = parseInt(revDaysSel.value||'30', 10);
  const rev = await g(`/api/metrics/revenue?days=${days}`);
  // Clear canvas
  ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);
  TinyChart.line(ctx,rev.map(x=>x.actual),{label:'Actual',color:'#22c55e'});
  TinyChart.line(ctx,rev.map(x=>x.goal),{label:'Goal',color:'#3b82f6'});
}
revDaysSel.addEventListener('change', loadRevenue);
revReload.addEventListener('click', loadRevenue);
await loadRevenue();

  // Live Data controls
  const refreshBtn = document.getElementById('refreshData');
  const setSheetsBtn = document.getElementById('setSheets');
  const setSheetFromUrlBtn = document.getElementById('setSheetFromUrl');
  const refreshOut = document.getElementById('refreshResult');
  // Pipeline & actions controls
  const viewPlanBtn = document.getElementById('viewPlan');
  const doResearchBtn = document.getElementById('doResearch');
  const doDraftBtn = document.getElementById('doDraft');
  const doRepurposeBtn = document.getElementById('doRepurpose');
  const approveBtn = document.getElementById('approve');
  const publishBtn = document.getElementById('publish');
  const qaChannelSel = document.getElementById('qaChannel');
  const qaTopicInput = document.getElementById('qaTopic');
  const btnFullVideo = document.getElementById('btnFullVideo');
  const btnBreaking = document.getElementById('btnBreaking');
  const jobsRefreshBtn = document.getElementById('jobsRefresh');
  const jobsOut = document.getElementById('jobsOut');
  // Explorer elements
  const srcSel = document.getElementById('srcSel');
  const keySel = document.getElementById('keySel');
  const fetchSheetBtn = document.getElementById('fetchSheet');
  const sheetOut = document.getElementById('sheetOut');

  // Set Sheets URLs (CSV exports)
  if (setSheetsBtn) {
    setSheetsBtn.onclick = async ()=>{
      try{
        const rev = prompt('Revenue CSV URL (public export):','');
        if (rev===null) return;
        const kpi = prompt('Content KPIs CSV URL (public export):','');
        if (kpi===null) return;
        const poll = prompt('Poll seconds (default 60):','60');
        const body = { revenue_csv_url: rev||'', content_kpis_csv_url: kpi||'', poll_seconds: parseInt(poll||'60',10) };
        const r = await p('/api/admin/update_sheets', body);
        alert('Saved. Reloading.');
        location.reload();
      }catch(e){ alert('Failed to save: '+e); }
    };
  }
 const adminOut = document.getElementById('adminOut');
 if (panicOn) panicOn.onclick = async ()=>{ adminOut.textContent='...'; adminOut.textContent=JSON.stringify(await p('/api/admin/panic/on',{}),null,2); };
 if (panicOff) panicOff.onclick = async ()=>{ adminOut.textContent='...'; adminOut.textContent=JSON.stringify(await p('/api/admin/panic/off',{}),null,2); };
 if (checkPanic) checkPanic.onclick = async ()=>{ adminOut.textContent='...'; adminOut.textContent=JSON.stringify(await g('/api/admin/panic_status'),null,2); };
  if (checkLast) checkLast.onclick = async ()=>{ adminOut.textContent='...'; adminOut.textContent=JSON.stringify(await g('/api/admin/last_refresh'),null,2); };

  // Populate Channels Explorer
  try {
    const cfg = await g('/api/sheets/config');
    const sources = cfg.sources || {};
    const names = Object.keys(sources).sort();
    names.forEach(n=>{ const o=document.createElement('option'); o.value=o.textContent=n; srcSel.appendChild(o); });
    function loadKeys(){
      keySel.innerHTML='';
      const sel = srcSel.value; const keys = (sources[sel]||[]).slice().sort();
      keys.forEach(k=>{ const o=document.createElement('option'); o.value=o.textContent=k; keySel.appendChild(o); });
    }
    srcSel.onchange = loadKeys; loadKeys();
  } catch(e){ /* no sources yet */ }
  if (fetchSheetBtn) fetchSheetBtn.onclick = async ()=>{
    sheetOut.textContent='Loading…';
    try{
      const src = srcSel.value; const key = keySel.value;
      const r = await g(`/api/sheets/${encodeURIComponent(src)}/${encodeURIComponent(key)}`);
      sheetOut.textContent = JSON.stringify(r,null,2);
    }catch(e){ sheetOut.textContent='Error: '+e; }
  };
})();
</script></body></html>
